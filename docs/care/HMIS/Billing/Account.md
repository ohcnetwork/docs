# Account

## Summary 
The **Account** module manages financial accounts that accumulate charges and payments for a patient or specific purpose (e.g. an inpatient stay or department cost center). An Account serves as a “billing bucket” or ledger for tracking healthcare costs over time ([Account - FHIR v6.0.0-ballot2](https://build.fhir.org/account.html#:~:text=A%20financial%20tool%20for%20tracking,a%20patient%2C%20cost%20centers%2C%20etc)). Charges (for services or items) are applied to an Account, and payments or adjustments credit the Account. In essence, it is a central record against which charges, payments, and adjustments are recorded ([Account - FHIR v6.0.0-ballot2](https://build.fhir.org/account.html#:~:text=The%20Account%20resource%20acts%20as,for%20payment%20of%20the%20account)). This allows the system to keep a running total of what a patient (or their insurance) owes. Accounts contain information about who the account is for (the patient or entity) and who is responsible for paying the balance (such as insurance or a guarantor). *For example, when a patient is admitted, an Account is opened to track all charges during that hospitalization, and later, an invoice will be generated from this account.*

**Note (Developers):** The Account concept aligns with the FHIR **Account** resource, providing a tool to track values accrued for a particular purpose in healthcare billing ([Account - FHIR v6.0.0-ballot2](https://build.fhir.org/account.html#:~:text=A%20financial%20tool%20for%20tracking,a%20patient%2C%20cost%20centers%2C%20etc)). While an account will have a running balance conceptually, it typically does **not** store a live balance field. Instead, the current balance is computed from all associated charges and payments ([Account - FHIR v6.0.0-ballot2](https://build.fhir.org/account.html#:~:text=While%20the%20Account%20does%20conceptually,in%20consideration%20as%20future%20work)). The system may provide a function to calculate the balance on demand by summing charges minus payments.

## Key Fields, Statuses, and Business Logic 
**Key Fields:**
- **Account Identifier:** Unique number or code for the account (often auto-generated) used to reference the account in the system. This might be visible on invoices or receipts for reference.
- **Name/Description:** A human-friendly name (optional) for the account, e.g. “John Doe – 2025 Inpatient Stay”, to help staff identify it.
- **Subject (Patient):** The patient (or entity) for whom the account is managed. Only charges for this patient should be applied. The account might also be tied to a specific **Encounter** or admission in the hospital (e.g. an account per hospitalization).
- **Account Type:** Categorizes the account, such as *inpatient*, *outpatient*, *pharmacy*, or other billing categories. This helps route the account to proper workflows. *(Developers: this corresponds to FHIR Account.type, and can be used for reporting or business rules.)*
- **Status:** The lifecycle state of the account. Common statuses include **active**, **on-hold**, **inactive** (closed), **entered-in-error**, or **unknown** ([Account - FHIR v6.0.0-ballot2](https://build.fhir.org/account.html#:~:text=%3Cstatus%20value%3D%22%5Bcode%5D%22%2F%3E%3C%21,billingStatus)).  
  - *Active:* The account is currently open and usable – new charges can be posted and invoices can be generated. Most patient accounts will be **active** during a patient’s care period.  
  - *On-hold:* The account is temporarily suspended (e.g. due to billing disputes or pending insurance information). Charges should not be added or invoices issued while on-hold. *(UI behavior: if staff attempt to add a charge or invoice on a held account, the system should block it and show a message.)*  
  - *Inactive (Closed):* The account is closed, typically after the care episode is finished and all charges have been billed and paid. No new transactions should occur. *(UI: the account may become read-only; any attempt to post charges should be prevented.)*  
  - *Entered-in-error:* The account was created by mistake and should not be used (e.g. duplicate account). Such accounts are ignored in billing.  
  - *Unknown:* The status is not known (this is rarely used; generally, an account will be deliberately set to one of the above states).  
  **Business logic:** New charges can only be applied to accounts in **active** status. If an account is **inactive** or on **on-hold**, the system must validate and disallow posting charges or creating invoices until the status is active. When closing an account (setting to inactive), ensure all pending charges are billed and no outstanding balance remains to avoid orphan transactions.
- **Coverage:** Insurance or coverage details associated with the account. This is the list of one or more insurance policies or payers that might pay for charges on this account (often with a priority order) ([Account - FHIR v6.0.0-ballot2](https://build.fhir.org/account.html#:~:text=,when%20processing%20billing%20coverage)). For example, a patient’s primary insurance coverage would be listed first, and perhaps secondary insurance next. This field helps determine how invoices/claims might be sent to insurers.  
  *(UI: When creating an account, staff can attach the patient’s insurance coverage. The interface might allow selecting from the patient’s known insurance policies, and marking the primary vs secondary coverage.)*  
- **Guarantor:** The person or organization responsible for any remaining balance on the account (after insurance). Often this is the patient themselves or a guardian/related person ([Account - FHIR v6.0.0-ballot2](https://build.fhir.org/account.html#:~:text=Reference%20,Organization%20%C2%BBA%20guarantor%20may%20be)). If insurance doesn’t fully cover the charges, the guarantor will be billed for the remainder.  
- **Owner (Managing Organization):** The department or organization that manages the account. For example, the hospital or a specific clinic department might “own” the account for internal tracking. *(This is mostly for internal bookkeeping; not always exposed to end-users.)*
- **Billing Period:** The date range that the account covers (e.g. admission and discharge dates, or a specific billing cycle). Charges with service dates outside this period might not be allowed. The system can use this to ensure charges fall within an episode of care.
- **Account Balance:** *This is not a stored field, but a computed value.* The current balance is calculated as **total charges** minus **payments/adjustments**. Staff will see the balance on the account UI, but under the hood it’s derived from the linked transactions. The account **balance** updates in real-time as new charges or payments are recorded (e.g., adding a charge increases the balance; recording a payment decreases it). ([Account - FHIR v6.0.0-ballot2](https://build.fhir.org/account.html#:~:text=While%20the%20Account%20does%20conceptually,in%20consideration%20as%20future%20work))

**Business Logic Highlights:**
- An account can accumulate many **Charge Items** (individual billed services) over time. Each Charge Item references the Account it belongs to. The Account itself does not list every charge internally; instead, charges “point” to the account ([Account - FHIR v6.0.0-ballot2](https://build.fhir.org/account.html#:~:text=The%20Account%20itself%20does%20not,have%20not%20yet%20been%20developed)). The system can retrieve all charges linked to a given account to compute the balance or prepare an invoice.
- **Adding Charges:** Only allowed on active accounts. If a user tries to add a charge to an inactive/on-hold account, the system should prevent it and alert the user (e.g., “Cannot add charges to a closed account”). This ensures data integrity.
- **Account Closure:** Typically done when the patient’s episode of care is complete and billing is finalized. The staff will mark the account as **inactive** (closed) after all invoices are issued and the balance is zero. The system might enforce that an account with outstanding balance cannot be closed. *(Developer note: implement a check that blocks closing an account if any unpaid invoices or unbilled charges exist.)* If closure is forced (exception cases), it should perhaps trigger warnings or require managerial approval.
- **On-hold Behavior:** Placing an account on hold might be used if, for example, insurance eligibility is in question or a billing dispute arises. In this state, new charges can be collected in the background (if necessary) but not officially billed until hold is released. The UI should visibly flag held accounts, and possibly require a note or reason for hold.
- **Responsible Parties:** The account’s **coverage** and **guarantor** information drive who gets billed in the **Invoice** process. For instance, an invoice might be split by coverage – first sent as a claim to insurance, then a remaining patient-responsible invoice to the guarantor. (This system is inspired by FHIR but may be simplified in implementation.)
- **Retrieving Balance:** Because the balance isn’t a stored field, whenever staff view the account, the system will calculate the balance by summing all *Charge Items* minus *Payments* related to that account. This ensures accuracy but requires that all related data be queried. *(Developer note: Consider providing an optimized way to compute balance, such as a database view or cached value updated on each transaction, if performance is a concern.)*

## Step-by-Step User Workflows and UI Interaction 

**Creating a New Account:**
1. **Navigation:** A billing staff or registrar navigates to the **Accounts** section of the HMIS. This might be accessible via a “Billing” menu or during patient admission in the system.
2. **Initiate Account Creation:** The user clicks on **“New Account”** (or an equivalent action). If the account is being created as part of patient registration or admission, some fields may be auto-filled (e.g., patient name, admission date).
3. **Enter Account Details:** A form is presented for the account details:  
   - Select or confirm the **Patient** for whom the account is being created (often this is pre-selected if coming from a patient context).  
   - Optionally enter an **Account Name/Description** (e.g., “2025-03 Ortho Surgery”).  
   - Choose an **Account Type** (from a dropdown, e.g., *Inpatient* vs *Outpatient*, if applicable).  
   - Initially, the **Status** will default to **active** (since we are opening a new active account).  
   - Add **Coverage details:** The user can attach insurance coverage. For example, they might pick the patient’s insurance policy from a list of the patient’s insurances on file. If multiple insurances apply, they can add more than one, possibly specifying the order (primary, secondary).  
   - The **Guarantor** will default to the patient (or guardian for a minor). The user can change it if, say, a company or another family member is responsible for the bill.  
   - Ensure the **start date** (or admission date) is correct; enter an end date if known (for example, if creating an account for a scheduled procedure on a single day, the end date might be that day).
4. **Save Account:** The user submits the form (by clicking **“Save”** or **“Create”**). The system validates the input (e.g., patient must be selected, type may be required, etc.). If everything is valid, a new Account record is created. The account is now **active** and ready to accept charges.  
   - *System response:* The UI might display a confirmation like “Account #12345 created successfully.” The account’s unique ID/number is generated (if not manually entered) and shown. The account detail page opens, showing the information entered and a current balance of $0.00.
5. **Post-Creation Actions:** From the new account’s page, staff can now perform actions like **“Add Charge”** (to add billable items) or **“Generate Invoice”** when ready. Initially, the account has no charges, so the balance is zero. The coverage and guarantor info is visible so staff know who will be billed.

**Viewing and Updating an Account:**
- Staff can search or browse for an existing account (for example, by patient name or account number). Selecting the account will typically bring up an **Account Details** screen. This screen shows:
  - Account info (patient, status, type, etc.) at the top.
  - Coverage/Insurance details and guarantor.
  - A list of all **Charge Items** posted to this account (often in a table format, with columns for date, description, amount, status).
  - A list of **Invoices** associated with the account (with invoice dates, amounts, status).
  - A list of **Payments** applied (with payment dates, amounts, and references).
  - The **Current Balance** calculated.
- Staff can update certain fields by clicking an **“Edit”** button (if the account is active):
  - For example, if the patient got a new insurance card mid-way, they could add a new Coverage or update the guarantor. Or they might correct the account name or type.
  - Some fields are not editable after creation: typically the patient and possibly the start date (since those are fundamental). If a mistake was made (wrong patient), often the recommended approach is to mark the account entered-in-error and create a new one.
  - Changing **Status:** Staff might set the account on **hold** if needed (the UI might require entering a reason note when doing so). They might also mark it **inactive** (close it) if the episode of care is over and billing is completed.
- When the user saves changes, the system validates them. For instance, if setting status to **inactive**, it might check if the balance is zero. If not, a warning “Cannot close account with outstanding balance” would appear and the action is blocked.

**Handling Account Holds:**
- If an account is on hold, the UI should prominently indicate this (e.g., a banner “On Hold”). While on hold, typical billing actions might be disabled or require override:
  - The “Add Charge” button might be hidden or greyed out with a tooltip “Account is on hold – cannot add charges.”
  - The “Generate Invoice” action might be disabled as well.
- To remove a hold, a staff user (often with appropriate permission) would edit the account and change status back to **active**. The system might log who removed the hold and when.

**Closing an Account (End of Cycle):**
- When all charges have been billed and paid, or the patient’s treatment cycle is over, the account should be closed. To do this, staff edits the account and sets **Status = Inactive**.
- The system will likely prompt “Are you sure you want to close this account? This action will mark the account as closed and no further charges can be added.” If confirmed, and validation passes (balance is zero, etc.), the status updates to inactive.
- Once inactive, the account is essentially archived for that episode. The UI might label it as **Closed**. Staff can still view details and history, but cannot add new entries. If somehow a late charge comes in after closure, typically a new account or special process is needed (or re-open the account, if the system allows toggling back to active with authorization).

**Account Balance Inquiry:** 
- At any point, staff might need to inform a patient of their current balance. The account screen’s balance is calculated from charges and payments in real-time. If the patient or billing staff want a detailed statement, they can generate an **Account Statement** (which is essentially an on-demand invoice or report of all transactions). This is usually separate from the official Invoice process, but it gives a breakdown of charges, payments, and remaining due.
- *UI Example:* A “Print Statement” button could produce a PDF listing all charges on the account, any payments received, and the net balance, useful for interim updates to patients before final billing.

## Developer Notes (Account Backend & Validation)
- **Data Model:** Each Account record should include references to the patient, coverage, guarantor, etc. Use relational links (e.g., patient ID foreign key) to quickly fetch related data. If modeling after FHIR, the Account is a standalone resource identified by an ID, with references to Patient, Coverage, etc.
- **Balance Calculation:** As noted, the account’s balance is computed, not stored. Implement a reliable method to sum all *ChargeItem* amounts linked to the account minus all *Payment* (PaymentReconciliation) amounts linked to the account. This might involve summing potentially many records, so consider indexing and efficient queries. Alternatively, maintain a running balance that updates on each transaction (though this must be carefully synchronized to avoid errors).
- **Status Transitions:** Enforce rules when updating account status:
  - Only allow **inactive** if balance is 0 and no pending charges. If there is a balance, return a clear error to the UI.
  - Only allow **on-hold** or **active** transitions for appropriate user roles. Possibly log these changes for audit.
  - **entered-in-error** should only be used shortly after creation or if truly needed, and might require admin privileges, since it essentially invalidates the account.
- **Unique Constraints:** Ensure account identifiers are unique (to avoid confusion in billing). If using human-readable numbers, implement a sequence or check to not duplicate an old account number.
- **Link to Encounter:** If the system ties accounts to encounters (common in hospital systems), ensure that one encounter is associated with only one primary billing account. Conversely, an account might cover multiple encounters in some models (like a global account for outpatient visits). Clarify this in design and enforce accordingly.
- **Coverage Priority:** If multiple coverages are attached, store the priority order. During invoice generation (especially if integrating with insurance claim logic), the order will determine who is billed first. The data model should capture priority (e.g., an integer rank or boolean for primary).
- **Auto-Creation Hooks:** In many systems, an account is automatically created when a patient is admitted or registered for a visit (to ensure every encounter has an account). As a developer, consider triggers: e.g., on creating an Encounter record, auto-generate an Account if none exists, and link them. This reduces manual workload on staff.
- **Deletion vs Error:** Generally, avoid deleting account records outright (especially if transactions exist). Instead, use the entered-in-error status or another flag to exclude erroneous accounts. This preserves an audit trail. If absolutely needed, only allow deletion on accounts with no charges or payments and done by admin.
- **Audit Logs:** Keep logs of changes to critical fields (status changes, coverage changes) for compliance. For example, if an account is put on hold, record who did it and why (perhaps as an internal note).
- **Integration Consideration:** If the HMIS integrates with a general ledger or financial system, the Account might map to a ledger account or sub-ledger. Developers might need to propagate account creation/closure events to that system.
- **Performance:** Accounts with a very large number of charges (e.g., a long hospitalization) might cause slow queries for balance or invoice generation. Mitigate by optimizing queries or splitting accounts by time periods if necessary (for instance, monthly billing accounts).
- **FHIR Alignment:** (Optional) If exposing an API or storing internally following FHIR, note that the Account resource doesn’t carry a balance field ([Account - FHIR v6.0.0-ballot2](https://build.fhir.org/account.html#:~:text=While%20the%20Account%20does%20conceptually,in%20consideration%20as%20future%20work)). Use FHIR operations (like `$balance` if defined) or custom operations to retrieve balances. Keep the FHIR resource updated with pointers to ChargeItem, Invoice, and PaymentReconciliation resources as appropriate to maintain referential integrity within the API.
