# Charge Item Definition

## Summary 
The **Charge Item Definition** module is essentially the **catalog or tariff** of billable services and goods in the hospital system. Each Charge Item Definition represents a template for a billable item – including its code, description, pricing, and any rules about when or how it is billed ([ChargeItemDefinition - FHIR v6.0.0-ballot2](https://build.fhir.org/chargeitemdefinition.html#:~:text=The%20ChargeItemDefinition%20resource%20provides%20the,type%20of%20billing%20code%20system)). In other words, if a Charge Item is an instance of something being billed to a patient, the Charge Item Definition is the definition of that billable thing in general (the price list entry). This is inspired by the FHIR ChargeItemDefinition resource, which “provides the properties that apply to the (billing) codes necessary to calculate costs and prices” ([ChargeItemDefinition - FHIR v6.0.0-ballot2](https://build.fhir.org/chargeitemdefinition.html#:~:text=The%20ChargeItemDefinition%20resource%20provides%20the,type%20of%20billing%20code%20system)).

The Charge Item Definition holds all relevant billing information for a given service or product. For example, there might be a definition for “General Physician Consultation” with code CONS100, base price $50, and rule that it’s only billable for outpatient visits. Another definition might be “MRI Scan – Brain” with code MRI001, price $500, and perhaps an additional surcharge rule for use of contrast material. The module ensures that all charges use consistent codes and pricing, and allows updates to pricing and rules in a centralized way.

## Key Fields and Configuration 
**Key Fields:**
- **Code (Billing Code):** A unique identifier for the chargeable item. This could be an alphanumeric code (like “MRI001” or “LAB123”). Staff will use this code to add charges. Codes may correspond to standard billing codes or internal codes. Each code in the system maps to one definition. *(In FHIR, this would be ChargeItemDefinition.code or part of a coded element.)*
- **Display Name/Description:** A clear name or description of the service/product. E.g., “MRI Scan - Brain with Contrast” or “Complete Blood Count (CBC)”. This is what shows up in drop-down lists and on bills. It should be understandable to both staff and patients.
- **Category:** (Optional) A grouping for reporting or UI organization (e.g., “Laboratory Tests”, “Radiology”, “Consultations”). This helps filter and find definitions when adding charges, and to group them on invoices.
- **Price/Rate:** The base price for the item. This could be a fixed amount (e.g., $500 per MRI) or a rate (e.g., $100 per hour for physiotherapy). If the item is time-based or quantity-based, the definition explains the unit. For example, a medication might be priced “per tablet” or a service “per session.” The price is typically stored as an amount with currency.
- **Unit of Measure:** If needed, the unit that the price applies to (each, per day, per kg, etc.). This field clarifies how to interpret quantity. E.g., “each” for most discrete items, or “hour” for hourly services. In many cases, this is implicit or included in description instead (like “Physio (per hour)”).
- **Applicable Period:** The date range during which this price is effective. There might be versioning of prices. For instance, if prices are updated annually, a definition can have an effective start date (and possibly end date). The system should pick the correct price based on the service date of the charge. If a charge date is outside the effective period of a definition, the system might warn or use the appropriate version of the definition (if multiple versions exist).
- **Applicability Conditions/Usage Rules:** Rules that define when this charge item definition can or should be applied ([ChargeItemDefinition - FHIR v6.0.0-ballot2](https://build.fhir.org/chargeitemdefinition.html#:~:text=Many%20billing%20systems%20have%20rules,Rules%20for%20applicability%20may%20include)) ([ChargeItemDefinition - FHIR v6.0.0-ballot2](https://build.fhir.org/chargeitemdefinition.html#:~:text=A%20billing%20engine%20will%20apply,Operation)). These can be quite complex or simple, for example:
  - The service is only billable in certain contexts (e.g., *outpatient only*, not for inpatient).
  - It may only be charged for patients within certain age ranges (e.g., pediatric vs adult pricing).
  - It can only be charged once per encounter or day (to prevent duplicates).
  - It must be used in combination with another code (or cannot be used together with another code).
  - Certain preconditions like time of day (e.g., an after-hours code that only applies outside 8am-5pm).
  - Limit frequency: e.g., “only one physical therapy session per day is billable”.
  These conditions might be described in text for human understanding and also encoded in a structured way for the system to enforce. In FHIR, these could be in properties and expressions within ChargeItemDefinition, and are applied via a billing engine ([ChargeItemDefinition - FHIR v6.0.0-ballot2](https://build.fhir.org/chargeitemdefinition.html#:~:text=A%20billing%20engine%20will%20apply,Operation)).
- **Price Components (Surcharges/Discounts):** Some definitions might include additional price components besides the base price ([ChargeItemDefinition - FHIR v6.0.0-ballot2](https://build.fhir.org/chargeitemdefinition.html#:~:text=,from%20the%20same%20billing%20system)). For example, “MRI with Contrast” might have a base price plus an additional contrast material charge. The definition can list these components so the system knows to add them. Another example: “After-hours service surcharge 20%” could be a separate definition that is referenced by rule. In FHIR, price components are part of Invoice for transparency ([Invoice - FHIR v6.0.0-ballot2](https://build.fhir.org/invoice.html#:~:text=balanced%20with%20this%20Invoice%20account,to%20the%20recipient%20of%20the)), but the logic originates from definitions (e.g., a flag that says “apply 1.2x price if after hours”).
- **Multiple Currency or Payer-specific Rates:** (If applicable) Some systems allow different prices for different payer types (e.g., insurance vs self-pay) or tiers. This could be handled by multiple definitions or extensions (like a specific contract price list for an insurer). Our documentation will assume a single standard price, but be aware this complexity exists.
- **Active/Inactive Flag:** Just like accounts, definitions can be active or inactive. An inactive definition means that code should no longer be used for new charges (perhaps it was replaced or the service is discontinued). The UI might hide inactive items from selection lists. If an inactive code is on an old invoice, it remains for historical data but no new charge should reference it.
- **Version or Identifier:** Optionally, a version number or reference ID if the catalog is maintained externally or for regulatory coding systems (like CPT codes version). This helps track if definitions were updated.
- **Associated Entities:** If relevant, link to the actual department or service entity. E.g., a definition for a lab test might reference the lab department, which could be used for routing approvals or notifications.
- **Narrative or Guidance:** Free-text notes explaining the usage of this code. For example, “Use this code for all standard chest X-rays. Do not use for portable X-ray, see code XRAY002 for portable.” These notes help human users choose correctly.

**Business Logic in Definitions:**
- **Single Source of Truth:** All chargeable items must have a definition entry. When adding a Charge Item, users pick from these definitions, ensuring consistency in naming and pricing. If a user attempts to enter a code that doesn’t exist in the definitions, the system should not allow it (or at least strongly discourage it). This prevents billing for undefined items.
- **Automated Price Calculation:** When a Charge Item is created, the system looks up the corresponding Charge Item Definition to retrieve the price and any conditional rules ([Invoice - FHIR v6.0.0-ballot2](https://build.fhir.org/invoice.html#:~:text=Since%20the%20individual%20ChargeItem%20resources,the%20context%20of%20the%20ChargeItem)). If the conditions in the definition apply, they are executed. For example, the definition might say “if quantity > 5, give 10% discount” (for bulk supplies). The system would then adjust pricing accordingly. Another example: “Service outside business hours – use surcharge code SURCH10.” The system might automatically add that surcharge as a separate charge or adjust the price as per definition.
- **Consistency and Updates:** If the hospital updates prices (say at the start of a new year, or due to inflation/cost changes), they will update the Charge Item Definitions. New charges will use the new prices. Historical charges remain with the old prices they were charged at (since those were recorded at the time of service with the then-effective price). This means the definition has to possibly store old prices or the system should keep track of from when a new price is effective.
- **Validation of Combinations:** The definitions drive the validation when adding charges:
  - They can specify incompatibilities or requirements. E.g., a definition could indicate “not billable with code X on the same day” – if the user tries to add both, the system can catch it.
  - They may specify prerequisites (like one code auto-adds another). The system could then auto-add the required code or prompt the user.
- **Optional Auto-Addition:** Some definitions might be configured to automatically add related charges. For example, if a certain procedure always includes a separate consumable fee, the system could prompt “Also add [consumable]?” or just add it when the main code is added. This behavior would be defined in the Charge Item Definition (like a linked supplementary charge).
- **Modifiability:** Usually, only authorized users (like billing administrators) can create or modify Charge Item Definitions, since it affects billing for all patients. Regular billing staff will have read-only access to this catalog when posting charges.
- **Impacts on UI:** The definitions might be used to populate drop-down lists. They might also determine how fields are presented. For example, if a service’s price is per hour, the UI could show a field to enter hours. If per item, it shows quantity. If a code has multiple price components (base + X), the UI might show a breakdown after selection. The goal is to give the user immediate feedback on what will be charged.

## Step-by-Step Workflows (Maintaining the Catalog)

**Adding a New Charge Item Definition (for Admin/Billing Manager):**
1. **Navigate to Charge Definitions:** A user with proper permission (e.g., Billing Manager) goes to the **Charge Item Definitions** or “Service Catalog” section of the HMIS. This could be under an admin or billing configuration menu.
2. **Initiate New Definition:** Click **“New Charge Item Definition”**. A form appears to input the details.
3. **Enter Code and Name:** Provide a unique **Code** for the item (the system might enforce uniqueness). Enter the **Description** name. For example, code: `CARD100`, name: “Cardiology Consultation (New Patient)”.
4. **Set Price:** Enter the **Price** for this service. E.g., $150.00. Optionally specify the unit (if not each). For the consultation, unit might be “per visit” (which could be implicit, so maybe no separate unit field needed).
5. **Category/Type:** Choose a **Category** like “Consultation” or “Cardiology”. (This helps in organizing items. The system might have a list of categories.)
6. **Applicability Rules:** Define any rules for this code:
   - If it’s specific to a setting: e.g., check a box “Outpatient only” or conversely “Inpatient only” if applicable.
   - If it’s age-specific: maybe fields to input min age or max age.
   - If it should not be combined with certain codes: possibly a multi-select to pick codes that conflict.
   - If it requires another code: a field to select the prerequisite code.
   - If there’s a frequency limit: input something like “Max 1 per day” or similar.
   Some systems might allow entering these via a simple UI, others might require writing an expression or just documenting it in notes. At minimum, an **internal note** can be recorded (like “Do not bill with follow-up consult on same day”). We assume a UI where common constraints can be toggled.
7. **Price Components/Surcharges:** If this item inherently includes multiple components, list them. For instance, if `MRI001` includes a contrast fee, one approach is to create a separate definition for contrast and then note it here. Alternatively, add a sub-entry in the form: “Additional Fee: Contrast Material $100 (applies if contrast used)”. Let’s say our UI allows adding a sub-line in the definition for surcharges or discounts. The admin could add: Condition: “Uses Contrast = Yes” then “Additional charge $100”. Another example: “Weekend surcharge 15%” as a condition (Day of week = Saturday/Sunday -> price * 1.15).
   - If the UI doesn’t support conditional components, the admin might instead create separate definitions for surcharges and rely on business rules to add them in combination.
8. **Effective Date:** Set when this price is effective. If this is a new code, it could be effective immediately (today’s date). If planning a price increase, one could set the effective date in the future. If the form allows, also set an end date if known (often left open-ended until changed).
9. **Activate Definition:** Ensure the definition is marked **Active** so it’s available for use. (Sometimes new entries might default to active unless a checkbox is provided to set it active/inactive.)
10. **Save:** Submit the form. The system validates uniqueness of code, required fields, numeric formats for prices, etc. If all good, it creates the new definition entry.
    - The new definition now appears in the catalog list. It should be available in the Charge Item selection UI for any new charges.
    - If there’s a sync or caching mechanism for the list of codes (for performance), ensure it refreshes so that the new code shows up for users immediately.

**Updating a Charge Item Definition (Price change or rule change):**
1. Go to the **Charge Item Definitions** list and search for the code or name in question. E.g., find “MRI Brain”.
2. Click **“Edit”** on that entry.
3. Change the necessary fields:
   - If updating the price: you might not want to overwrite the old price if charges already used it. Ideally, to handle price changes, one would *add* a new effective period. For instance, the form might allow adding a new price effective from a certain date. If the UI is simpler, an admin might just change the price field. In such case, the system should possibly warn “This will change the price for all future charges; existing charges are not affected.” and maybe automatically set an effective date for the new price (like today).
   - Adjust description if needed (maybe to clarify something).
   - Modify rules: e.g., broaden age range, or add a new incompatible code.
   - Possibly mark the old price as ended yesterday and new price from today if system supports multiple records or a history.
4. Save changes. The system validates and updates the definition. If versioning is supported, it might actually create a new version entry under the hood rather than simply editing (so that historical data remains tied to old version).
5. After saving, new charges added will use the updated definition. Existing Charge Items already posted are not retroactively changed (they retain the price at which they were added, since those are stored with the charge).

**Deactivating (Retiring) a Charge Item Definition:**
- If a service is no longer offered or a code is deprecated, an admin can mark it as **Inactive**. This usually involves editing the definition and unchecking an “Active” box or setting a termination date.
- Save the change. Inactive definitions are typically hidden from the charge entry UI so that staff won’t accidentally use them. If they try to use an inactive code (say by typing it manually), the system should reject it.
- The definition remains in the database for reference (especially for old records that used it), but it’s not available for new charges. If there’s a replacement code, the admin might add a note like “Replaced by CODE123 as of 2025”.

**Viewing the Catalog:**
- The Charge Item Definition list can usually be viewed in a table format by authorized users. It might show columns: Code, Description, Price, Unit, Active/Inactive, etc.
- Users (like billing staff) with view-only access can search this list to find how something is billed. For example, “How much is the charge for an MRI spine?” They can find the definition entry for MRI spine which says, e.g., $400.
- This ensures transparency: staff can answer patient queries about costs using the official catalog.

**Using Definitions during Charge Entry (UI perspective):**
- As mentioned earlier, when adding a charge (Charge Item), the system references this catalog. The search or dropdown is driven by the definitions. If a code is updated or newly added, that is immediately reflected to the end user adding charges.
- If a user somehow doesn’t find a desired code (maybe it’s new or they are using an old term), there might be a process to either look up synonyms or request a new code. The definitions can have synonyms or keywords for searching. E.g., if a user types “blood sugar”, it could match a definition for “Glucose test”.
- If the user selects a code that has specific rules, the UI might give immediate feedback. For instance, if a code is “Inpatient only” and they’re trying to add it on an outpatient account, upon selection the system could show a warning “This code is typically for inpatient use; please verify.” It might still allow if the user insists (or might block entirely depending on strictness).

## Developer Notes (Definition Module & Pricing Engine)
- **Data Structure:** Maintain a table for ChargeItemDefinitions with fields as above (code, description, price, etc.). If you need to support price history, you might have a linked table for prices with effective dates. Alternatively, include validity dates in the main table and create a new record for the same code when updating price (differentiated by version or effective date). Ensure that there’s a way to fetch the correct price by date.
- **Unique Code Constraint:** Enforce unique codes at the database level. Also possibly enforce no overlap of effective periods for the same code (to avoid ambiguity in price on a given date).
- **Performance (Lookup):** The list of definitions could be large if the hospital has many services. Use indexing on code and description for fast search. When a user is typing to search, consider a search service or caching popular terms in memory for quick auto-complete. Ensure inactive codes are either filtered out or clearly marked.
- **Applying Definitions to Charges:** Implement a function like `applyDefinition(charge, definition)` that:
  - Checks each rule in the definition against the context (patient, account, other charges).
  - Adjusts the charge’s allowed status or price accordingly.
  - For example, if definition says “not billable for age > 14” and patient is 20, then perhaps `charge.status = not-billable` by default or a warning is raised. However, usually one wouldn’t add such a charge for an adult at all (the UI might filter it out).
  - Another example: definition has a condition “if after hours, add 50”. If charge time is 9pm, either add a separate charge automatically or append a component. A simple method: create a hidden surcharge definition and auto-add a ChargeItem for it. Or adjust the price of the current charge. Decide on one approach and implement consistently.
- **Compound Pricing:** FHIR suggests multiple price components (like base price, surcharge, discount) for transparency ([Invoice - FHIR v6.0.0-ballot2](https://build.fhir.org/invoice.html#:~:text=balanced%20with%20this%20Invoice%20account,to%20the%20recipient%20of%20the)). If implementing that, your ChargeItemDefinition might list components rather than a single price. For instance, base = 100, night surcharge = 20%. At runtime, you’d calculate total = 100 + (20% of 100). You might want to store both components to show on invoice (like “Base fee $100, After-hours surcharge $20”). This can be done by generating two separate line items (which could confuse patients) or by supporting a composite structure in the invoice line. We discuss invoice presentation in the Invoice section.
- **Validation vs Enforcement:** Some rules might be soft (warnings) and some hard (errors). Decide which rules absolutely prevent charge entry (and implement as such). Others implement as warnings that the user can override with a justification (store that justification).
- **Administration UI:** Provide a secure UI for managing definitions. Only certain roles should access this. Also, consider logging changes (who changed a price or rule, old vs new values).
- **Impacts of Changes:** Changing a price definition should not retroactively update already posted charges. Ensure that when applying definitions to a ChargeItem, you stamp the price at that time. If you store just a reference to the definition and calculate on the fly, then historical invoices might change if definitions change – which is undesirable. Therefore, better to store the resolved price in ChargeItem (or invoice line). If you need to reproduce an old invoice exactly, you cannot rely on current definition data. 
  - Some implementations handle this by version: each invoice or charge stores the code *and a reference to the definition version*. If someone needs to understand that price, they refer to the definition version record.
- **Interdependence of Definitions:** If you have rules like “code A requires code B”, ensure both exist. Possibly create a mechanism of linking definitions (like references or foreign keys for prerequisites). If code B is removed or changed, update code A’s rule as well.
- **Testing Scenarios:** It’s important to test various combinations:
  - A charge with multiple applicable rules (e.g., patient under 14 AND after hours – does it get two modifications?).
  - Ensure no double-counting surcharges (applying same rule twice).
  - If two different rules conflict (unlikely if curated well, but e.g., one rule says “price = 100” another says “price = 80 for same condition” – the system should have a clear precedence or just not allow contradictory rules).
- **Bulk Updates:** If prices increase by a percentage across the board, it might be helpful to have a script or tool to update many definitions at once (rather than manually editing each). Consider designing an import or bulk update interface, especially if prices come from an external source like a national fee schedule.
- **FHIR Alignment:** The structure here corresponds to FHIR’s ChargeItemDefinition. If planning to export or import FHIR resources:
  - The rules might be represented as `applicability` expressions in FHIR or `propertyGroup` with `priceComponent`. You would map your internal representation to those. 
  - The $apply operation in FHIR can take a ChargeItemDefinition and a context (patient, etc.) and return computed price components ([ChargeItemDefinition - FHIR v6.0.0-ballot2](https://build.fhir.org/chargeitemdefinition.html#:~:text=A%20billing%20engine%20will%20apply,Operation)). You may implement something analogous internally. For example, when finalizing an invoice, for each charge, you could conceptually perform a mini `$apply` to ensure all pricing rules have been applied correctly.
- **Error Handling:** If a user tries to add a charge and the system can’t find a definition (which shouldn’t happen if UI prevents it), handle it gracefully – maybe show “Unknown code” error. Similarly, if a definition exists but has no price (maybe an oversight), do not charge $0 silently; flag it so it can be corrected.
- **Edge Cases:** Consider a scenario where a definition is updated while someone is in the middle of entering charges. If they had the form open with old data and then save, could that conflict? To avoid issues, you might lock definitions editing during peak usage or have the charge posting always re-fetch the latest definition when saving.
- **Security:** Because charge definitions determine revenue, they should be secure. Only authorized changes, and perhaps double-check expensive items. Sometimes an approval is needed for major price changes (two sets of eyes rule). This might be beyond our current scope but keep audit logs for definition changes to catch any accidental or malicious edits.
