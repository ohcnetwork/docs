# CEP-13: Multi-Factor Authentication (MFA) for Enhanced Security in CARE

### Motive

Care is being used in various healthcare environments for managing patient information and care delivery. Security is a critical aspect of healthcare applications, especially when dealing with sensitive patient data. Implementing multi-factor authentication (MFA) in CARE will provide an additional layer of security to protect user accounts and patient information from unauthorized access.

### Requirements

### **1. MFA Methods to Support**

- **Primary MFA Methods:**
  - **TOTP (Time-Based One-Time Password):** Using authenticator apps like Google Authenticator, Authy, etc.
- **Secondary MFA Methods:**
  - **OTP via SMS:** One-time passwords sent to the user's registered mobile number.
  - **OTP via Email:** One-time passwords sent to the user's registered email address.
- **Backup Options:**
  - **Backup Codes:** One-time use codes provided to users for account recovery.
- **Future Support:**
  - **Passkeys:** Implement passwordless authentication methods using WebAuthn and FIDO2 standards.

### **2. User Flows**

#### **Setup MFA**

- **Initiate Setup:**
  - Users navigate to their account settings and select "Enable MFA."
  - Password verification is required to proceed.
- **Primary MFA Setup (TOTP):**
  - The system generates a unique secret key and provisioning URI.
  - Users scan a QR code with their authenticator app or enter the secret key manually.
  - Users confirm setup by entering a TOTP code from the app.
- **Secondary MFA Setup (Optional):**
  - Users are prompted to set up a secondary MFA method (SMS or Email).
  - An OTP is sent via the selected method for verification.
- **Backup Codes:**
  - Users are provided with backup codes to save securely.
- **Notifications:**
  - Users receive email notifications upon successful MFA setup.

#### **Login with MFA**

- **Initial Authentication:**
  - Users enter their username and password.
- **MFA Verification:**
  - If MFA is enabled, users are prompted to enter a code from their primary MFA method.
  - Links to secondary MFA options are provided if the primary method is unavailable.
- **Failed Attempts Handling:**
  - After 3 consecutive failed attempts, users receive a warning.
  - After 5 consecutive failed attempts, the account is locked for 15 minutes.
  - Notifications are sent to the user and admin regarding the lockout.

#### **Viewing and Managing MFA Settings**

- **Accessing MFA Settings:**
  - Users can view their enabled MFA methods in account settings.
  - Details such as masked email or phone number are displayed for secondary methods.
- **Editing or Disabling MFA:**
  - Password verification is required to make changes.
  - Users enforced by admin policy cannot disable MFA.
  - Users can enable, disable, or modify MFA methods.
- **Notifications:**
  - Users receive email notifications upon changes to MFA settings.

### **3. Admin Controls**

- **Enforcing MFA:**
  - Admins can enforce MFA for all users or specific roles.
  - Users are prompted to set up MFA on their next login.

---

### Routes

**Setup**

> > POST `/api/v1/mfa/setup/initiate/`

- User requests to enable MFA. Requires password verification.

```json
{ "password": "user_password" }
```

- **Response:**
- On success: Proceed to TOTP setup.
- On failure: Return error message.

> > GET `/api/v1/mfa/totp/setup/`

- Retrieve TOTP provisioning URI and QR code data after password verification.
- Response
  {
  "uri": "otpauth://totp/CARE:user@example.com?secret=SECRET&issuer=CARE",
  "secret_key": "BASE32SECRET"
  }

> > POST `/api/v1/mfa/totp/verify/`

- User submits TOTP code to confirm setup.
- Request

```json
{
  "code": "123456"
}
```

- Response
- On success: Enable TOTP MFA in `MFASettings`.
- On failure: Return error message.

> > POST `/api/v1/mfa/sms/setup/

- User selects and sets up secondary MFA method.
- Response
- Sends an OTP to user registered Phone number.

> > POST `/api/v1/mfa/sms/verify/`

- User submits OTP code received via email or SMS.
- Request

```json
{
  "code": "123456"
}
```

- Response
- On success: Enable selected secondary MFA in `MFASettings`.
- On failure: Return error message.

> > POST `/api/v1/mfa/backup-codes/generate/`

- Generates and returns backup codes to the user.
- Request

```json
{
 "backup_codes": ["code1", "code2", "code3", ...]
}
```

---

**Login flow**

> > POST `/api/v1/auth/login/`

- User submits username and password.
- Request

```json
{
  "username": "user@example.com",
  "password": "123456"
}
```

- Response:
- If MFA is enabled, return indication that MFA code is required.
- Include temporary token or session identifier.
- If MFA is not enabled it is a regular flow.

```json
{
  "mfs_required": true,
  "temp_token": "temporary_token_from_login_response"
}
```

> > POST `/api/v1/mfa/verify/`

- User submits MFA code (TOTP, SMS, Email, or Backup Code).
- Request

```json
{
  "method": "totp", // or "sms", "email", "backup_code"
  "code": "123456",
  "tmp_token": "temporary_token_from_login_response"
}
```

- Response
- On success: Issue access token and refresh token
- On failure: Return error message; handle failed attempts and lockouts.

> > POST `/api/v1/mfa/sms/request/`

- User requests an OTP via SMS
- Request

```json
{
  "tmp_token": "temporary_token_from_login_response"
}
```

- Response
- Shows OTP is sent

similar flow for Email.

---

**View after enabling the MFA**

> > GET /api/v1/mfa/settings/

- Retrieve the user's current MFA settings.
- Response

```json
{
  "is_mfa_enabled": true,
  "is_totp_enabled": true,
  "is_sms_enabled": true,
  "is_email_enabled": false,
  "is_backup_codes_enabled": true,
  "force_mfa": false,
  "email": "user@example.com",
  "phone_number": "+91 9994445638"
}
```

> > POST /api/v1/mfa/disable

- User will be prompted to enter the password before disabling the password
- Request

```json
"method": "totp",  // or "sms", "email", "backup_code"
```

- Response
- On success: Disable the selected MFA method.
- On failure: Return error message.

---

Next

- [ ] Need to write models.
- [ ] Improve API route urls names
- [ ] Understand How Care plug works and figure out / Can't we do SMS/EMAIL providers configuration from some config ? https://github.com/roaldnefs/django-sms
- [ ] Understand MFA configuration at instance level means - at deployment level ?
- [ ] Understand how does emails work and go in Django
- [ ] Rate limits and storing keys securly
- [ ] Which package to use - pyotp or django-two-factor-auth -> for traditional Django templates but can eb extendable.

---

![image](https://gist.github.com/user-attachments/assets/1ef04fac-d382-41f6-9882-f927b312836e)

### References

- [Dump for CEP](https://gist.github.com/yash-learner/b9cd90662d5dfc087f2be9fbc9d23817/)
- [pyotp](https://pypi.org/project/pyotp/)
